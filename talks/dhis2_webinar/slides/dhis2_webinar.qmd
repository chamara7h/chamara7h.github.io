---
format: 
  revealjs:
    slide-number: c/t
    width: 1920
    height: 1080
    logo: "images/logo.png"
    footer: "[From Cases to Consumption: Evaluating CHAP/DHIS2 Model Portability for Health Supply Chains](https://chamara7h.github.io/talks/)"
    css: theme.css
    echo: true
execute:
  warning: false
  echo: false
header-includes:
  - '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'
  

---   

# {.title-slide background-image="images/cover.png" background-size="cover"}

<div class="logo-container">
  <img src="images/cardiff_logo.png" alt="Cardiff University Logo">
  <img src="images/logo.png" alt="Data Lab Logo">
  <img src="images/uio_HISP.svg" alt="HISP UIO Logo">
  <img src="images/DHIS2_logo.svg" alt="DHIS2 Logo">
  <img src="images/wgss.png" alt="WGSSS Logo">
  <img src="images/ukri.png" alt="UKRI Logo">
</div>

<div class="title-slide">
  <h1>From Cases to Consumption</h1>
  <h2>Evaluating CHAP/DHIS2 Model Portability for Health Supply Chains</h2>
  <p class="author">Data Lab for Social Good, Cardiff University in collaboration with HISP Centre, University of Oslo</p>
  <p class="date">2025/10/29</p>
</div>

## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/outline.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

<br>

<br>

[Outline]{.highlight-title}

::: {.step data-step="01"}
<div class="step-content">
  <h3>Background</h3>
</div>
::: 

::: {.step data-step="02"}
<div class="step-content">
  <h3>The fundamental question</h3>
</div>
:::

::: {.step data-step="03"}
<div class="step-content">
  <h3>What we are going to do</h3>
</div>
:::

::: {.step data-step="04"}
<div class="step-content">
  <h3>Our current plan</h3>
</div>
:::

::: {.step data-step="05"}
<div class="step-content">
  <h3>Initial results</h3>
</div>
:::

::: {.step data-step="06"}
<div class="step-content">
  <h3>What [NEXT?]{.highlight-blue}</h3>
</div>
:::

:::

::::

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>BACKGROUND</h1>
</div>

## {}

:::: {.columns}

::: {.column width="40%"}
![](images/background.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}
[The Problem: A tale of two data streams]{.highlight-title}

<br>

Health supply chains are struggling with forecasting at sub-national/ facility level.

- Operational realities: Incomplete records, irregular orders, frequent manual adjustments.

- This masks true demand and leads to a cycle of...

- Persistent, critical stockouts üìâ.

::: {.fragment fragment-index=1}

<br>

[But... we have a success story.]{.highlight-blue-big}

Platforms like [DHIS2]{.highlight-blue} and [CHAP]{.highlight-blue} have robust, high-performing models for forecasting disease cases (morbidity).

:::

:::

::::


## The fundemental question

<br>

‚úÖ We're good at forecasting cases (e.g., malaria).

<br>

‚ùå We're struggling with forecasting consumption (e.g., antimalarials).

<br>
<br>

::: {.fragment}
[Can we leverage the CHAP/DHIS2 morbidity models to forecast product consumption in supply chains?]{.highlight-blue-big}
:::

## The challenge: Why isn't this easy?

<br>

Case data and consumption data are different.

<br>

<div class="stretch-cols">

:::: {.columns}

::: {.column width="50%"}

::: {.fragment fragment-index=1 .minimal-box} 

<i class="fa-solid fa-database ch-icon" aria-hidden="true"></i> **Different Data Structures** 

Consumption data is ["messier"]{.highlight-blue}.

- Missing entries (e.g., "0" = no consumption, or "0" = data not entered?)
- Intermittency (infrequent demand).
- Inconsistent recording.
  
:::

:::

::: {.column width="50%"}

::: {.fragment fragment-index=2 .minimal-box}  

<i class="fa-solid fa-list-check ch-icon" aria-hidden="true"></i> **Different Metadata**

Consumption is affected by logistics.

- Lead times.
- Procurement cycles.
- Existing stock levels and stockouts.
  
:::

:::

::::

</div>

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>OUR APPROACH</h1>
</div>

## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/rqs.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

[Our research questions]{.highlight-title}

<br>

To solve this, we are investigating three key questions:

<br>

::: {.fragment fragment-index=1}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **Portability**: When can we transfer a model? (Morbidity $\rightarrow$ Consumption? One product $\rightarrow$ Another?)

:::

<br>

::: {.fragment fragment-index=2}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **Decision Translation**: How do we turn a statistical forecast into a better inventory order? (Forecast $\rightarrow$ Action)

:::

<br>

::: {.fragment fragment-index=3}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **Hierarchical Coherence**: Do site-level forecasts reliably add up for district and national planning?

:::

:::

::::

## What we are going to do

:::: {.columns}

::: {.column width="50%"}

![](images/model.png){style="width:100%; height:auto; "}

:::

::: {.column width="2.5%"}

:::

::: {.column width="47.5%"}

<br>

We've organized our work into three interconnected Work Packages (WPs).

<br>

[WP1: Portability]{.highlight-blue} (Test reuse/transfer. Create "if/then" rules.)

$\downarrow$

[WP2: Forecast $\rightarrow$ Inventory]{.highlight-blue} (Translate forecasts into real-world inventory policy.)

$\downarrow$

[WP3: Hierarchical Coherence]{.highlight-blue} (Test aggregation for national procurement.)

:::

::::

## Our current plan

Our immediate focus is on WP1 (*Portability*) and linking to WP2 (*Inventory Simulation*).

![](images/wp1.svg){style="width:100%; height:auto; "}

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>INITIAL FINDINGS</h1>
  <h2>Forecasting using morbidity data.</h2>
</div>


## Data exploration

We used number of dengue cases in Laos to test the forecasting models.


```{r}
#| include: false

library(tidyverse)
library(tsibble)
library(fable)
library(feasts)
library(ggthemes)
library(viridis)
library(patchwork)
library(kableExtra)

# Read and prepare monthly data -------------------------------------------

dengue_monthly <- read_csv('data/tidy_data/historic_data.csv') |> 
  mutate(time_period = yearmonth(time_period)) |> 
  select(-c(`...1`, parent)) |> 
  as_tsibble(index = time_period,
             key = location) |> 
  mutate(disease_cases = if_else(is.na(disease_cases), 0, disease_cases))

# Forecast accuracy

fc_acc <- read.csv('data/results/fc_evaluations.csv') |> 
  mutate(origin = yearmonth(forecast_start),
         model = factor(model))

```

```{r}
#| label: fig-ts_feat
#| echo: false
#| cache: true
#| out.width: "100%"
#| fig-cap: "Monthly dengue cases by location."

# plot

dengue_monthly |>
  ggplot(aes(x = time_period, y = disease_cases, group = location, colour = location)) +
  geom_line(size = 0.7, colour = "#1a2b48", alpha = 0.95) +
  facet_wrap(~ location, scales = "free_y", ncol = 4) + 
  labs(
    x = "Date",
    y = "Number of cases",
    # title = "Monthly dengue cases by location",
  ) +
  scale_colour_viridis_d(begin = 0.15, end = 0.85) +
  theme_few(base_size = 11) +
  theme(
    panel.background   = element_rect(fill = "#f9f9f9", colour = NA),
    panel.grid.major.y = element_line(colour = "grey92", size = 0.35),
    panel.grid.major.x = element_blank(),
    panel.grid.minor   = element_blank(),
    panel.border       = element_rect(color = "lightgrey", fill = NA, size = 0.4),
    strip.background   = element_rect(fill = "#ffffff", colour = "#e6e6e6"),
    strip.text         = element_text(face = "bold", size = 9, colour = "#1a2b48"),
    axis.title         = element_text(face = "bold", size = 10, colour = "#1a2b48"),
    axis.text          = element_text(size = 8, colour = "#1a2b48"),
    plot.title         = element_text(face = "bold", size = 13, colour = "#1a2b48", hjust = 0),
    plot.subtitle      = element_text(size = 10, colour = "#1a2b48", margin = margin(b = 8)),
    legend.position    = "none",
    panel.spacing      = unit(0.6, "lines")
  )


```


## Ovreall forecast performance

Best values in each column are highlighted in bold.

```{r}
#| echo: false
#| results: asis
#| label: tbl-fc_acc

set_to_bold_min_html <- function(tbl, cols = 2:3, digits = 3) {
  df <- as.data.frame(tbl, stringsAsFactors = FALSE)
  cols <- cols[cols <= ncol(df)]
  if (length(cols) == 0) return(df)
  
  for (i in cols) {
    vec_num <- suppressWarnings(as.numeric(as.character(df[[i]])))
    
    if (all(is.na(vec_num))) {
      df[[i]] <- rep("", nrow(df))
      next
    }
    
    rounded <- round(vec_num, digits)
    best_mask <- !is.na(rounded) & rounded == min(rounded, na.rm = TRUE)
    
    fmt <- paste0("%.", digits, "f")
    formatted <- ifelse(is.na(rounded), "", sprintf(fmt, rounded))
    
    formatted[best_mask] <- paste0("<strong>", formatted[best_mask], "</strong>")
    
    df[[i]] <- formatted
  }
  
  return(df)
}

fc_acc |> 
  select(model, item_id, MASE, QuantileLoss.0.1., QuantileLoss.0.5., QuantileLoss.0.9.) |> 
  rename(quantile_loss_10 = `QuantileLoss.0.1.`,
         quantile_loss_50 = `QuantileLoss.0.5.`,
         quantile_loss_90 = `QuantileLoss.0.9.`,
         location = item_id) |> 
  group_by(model) |> 
  summarise(mase = round(mean(MASE), 3),
            quantile_loss_10 = round(mean(quantile_loss_10), 3),
            quantile_loss_50 = round(mean(quantile_loss_50), 3),
            quantile_loss_90 = round(mean(quantile_loss_90), 3),
            .groups = 'drop') |> 
  arrange(mase) |> 
  rename('Model' = model, 
         'MASE' = mase,
         'Quantile Loss (q10)' = quantile_loss_10,
         'Quantile Loss (q50)' = quantile_loss_50,
         'Quantile Loss (q90)' = quantile_loss_90) |> 
  
  set_to_bold_min_html(cols = 2:5, digits = 3) |> 
  
  kbl(
    format     = "html",
    escape     = FALSE, 
    table.attr = 'class="table-custom"',
    align      = "lrrrr" 
  ) |>
  kable_styling(full_width = FALSE, font_size = 32)

```

## Ovreall point forecast performance across forecast origins

```{r}
#| label: fig-fcc_ac_origins
#| echo: false
#| cache: false
#| fig-cap: "Overall MASE accross forecast origins"

fc_acc |> 
  group_by(origin, model) |>
  summarise(MASE = mean(MASE)) |>
  ggplot(aes(x = origin, y = MASE, group = model, colour = model)) +
  geom_line(size = 0.5, alpha = 0.95) +
  geom_point(aes(shape = model), size = 2, stroke = 0.75) +   # shapes here
  scale_color_viridis_d(option = "viridis", begin = 0.1, end = 0.95) +
  scale_shape_manual(values = 1:14) +
  labs(
    x = "Forecast Origin",
    y = "MASE",
    colour = "Model",
    shape = "Model"
  ) +
  theme_few(base_size = 10) +
  theme(
    panel.background   = element_rect(fill = "#f9f9f9", colour = NA),
    panel.grid.major.y = element_line(size = 0.35, colour = "grey90"),
    panel.grid.minor   = element_blank(),
    strip.background   = element_rect(fill = "#ffffff", colour = "#e6e6e6"),
    strip.text         = element_text(face = "bold", size = 8, colour = "#1a2b48"),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(size = 10, face = 'bold'),
    legend.text        = element_text(size = 8)
  ) 

```

## Ovreall point forecast performance across each location

```{r}
#| label: fig-fcc_ac_locations
#| echo: false
#| cache: false
#| fig-cap: "Overall MASE accross forecast origins for each location."

fc_acc |> 
  ggplot(aes(x = origin, y = MASE, group = model, colour = model)) +
  geom_line(size = 0.5, alpha = 0.95) +
  geom_point(aes(shape = model), size = 2, stroke = 0.75) +   # shapes here
  scale_color_viridis_d(option = "viridis", begin = 0.1, end = 0.95) +
  scale_shape_manual(values = 1:14) +
  facet_wrap(~ item_id, scales = "free", ncol = 3) +
  labs(
    x = "Forecast Origin",
    y = "MASE",
    colour = "Model",
    shape = "Model"
  ) +
  theme_few(base_size = 8) +
  theme(
    panel.background   = element_rect(fill = "#f9f9f9", colour = NA),
    panel.grid.major.y = element_line(size = 0.35, colour = "grey90"),
    panel.grid.minor   = element_blank(),
    strip.background   = element_rect(fill = "#ffffff", colour = "#e6e6e6"),
    strip.text         = element_text(face = "bold", size = 5, colour = "#1a2b48"),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(size = 8, face = 'bold'),
    legend.text        = element_text(size = 6)
  )

```
# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>WHAT NEXT</h1>
</div>

## {}

:::: {.columns}

::: {.column width="40%"}
![](images/wp2.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

[Way forward]{.highlight-title}

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Leverage CHAP/DHIS2 based models for supply chain data.

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Evaluate forecast perfromance based on time series structure, region and across products.

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Run order up-to-level based inventory simulations.

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Evaluate how forecast performance translate into inventory decisions.

:::

::::

## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/cover2.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

[Key takeaways]{.highlight-title}

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **The Idea**: Reusing morbidity models for supply chains is a promising but non-trivial opportunity.

<br>

::: {.fragment fragment-index=1}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **Our Contribution**: We‚Äôre building an evidence-based, practical guide for when and how to repurpose morbidity models for consumption forecasting, leveraging CHAP‚Äôs modelling infrastructure and DHIS2-linked data.

:::

<br>

::: {.fragment fragment-index=2}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **The Impact**: By aligning forecasts with operational decisions, this work aims to improve stock availability, and inform sourcing/procurement decisions.

:::

<br>

::: {.fragment fragment-index=3}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> **Compatibility**: CHAP/DHIS2‚Äôs external model interface makes it possible to integrate these forecasting tools seamlessly, no new platform required.

:::

:::

::::

## Any questions or thoughts? üí¨ 

![](images/follow_us.png){fig-align="center"}




