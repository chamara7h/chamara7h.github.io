---
format: 
  revealjs:
    slide-number: c/t
    width: 1920
    height: 1080
    logo: "images/logo.png"
    footer: "[Leveraging Chap and the DHIS2 Platform for Stock Forecasting](https://chamara7h.github.io/talks/)"
    css: theme.css
    echo: true
execute:
  warning: false
  echo: false
header-includes:
  - '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'
---   

# {.title-slide background-image="images/cover.png" background-size="cover"}

<div class="logo-container">
  <img src="images/cardiff_logo.png" alt="Cardiff University Logo">
  <img src="images/logo.png" alt="Data Lab Logo">
  <img src="images/uio_HISP.svg" alt="HISP UIO Logo">
  <img src="images/DHIS2_logo.svg" alt="DHIS2 Logo">
  <img src="images/wgss.png" alt="WGSSS Logo">
  <img src="images/ukri.png" alt="UKRI Logo">
</div>

<div class="title-slide">
  <h1>Live Demo</h1>
  <h2>Leveraging Chap and the DHIS2 Platform for Stock Forecasting</h2>
  <p class="author">Data Lab for Social Good Research Group in collaboration with HISP Centre, University of Oslo</p>
  <p class="date">2026/01/27</p>
</div>


## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/outline.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

<br>

<br>

[Outline]{.highlight-title}

::: {.step data-step="01"}
<div class="step-content">
  <h3>Background</h3>
</div>
::: 

::: {.step data-step="02"}
<div class="step-content">
  <h3>The fundamental question</h3>
</div>
:::

::: {.step data-step="03"}
<div class="step-content">
  <h3>What we are going to do</h3>
</div>
:::

::: {.step data-step="04"}
<div class="step-content">
  <h3>What did we find</h3>
</div>
:::

::: {.step data-step="05"}
<div class="step-content">
  <h3>Live demo</h3>
</div>
:::

:::

::::

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>BACKGROUND</h1>
</div>

## {}

:::: {.columns}

::: {.column width="40%"}
![](images/background.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}
[The Problem: A tale of two data streams]{.highlight-title}

<br>

Health supply chains are struggling with forecasting at sub-national/ facility level.

- Operational realities: Incomplete records, irregular orders, frequent manual adjustments.

- This masks true demand and leads to a cycle of persistent, critical stockouts.

::: {.fragment fragment-index=1}

<br>

[But... we have a success story.]{.highlight-blue-big}

<br>

Platforms like [DHIS2]{.highlight-blue} and [CHAP]{.highlight-blue} have robust, high-performing models for forecasting disease cases (morbidity).

:::

:::

::::


## The fundemental question

<br>

‚úÖ We're good at forecasting cases (e.g., malaria).

<br>

‚ùå We're struggling with forecasting consumption (e.g., antimalarials) at sub-national level.

<br>

::: {.fragment}
[Can the same CHAP morbidity models and pipelines be *ported* to health commodity demand and inventory decisions?]{.highlight-blue-big} 
:::

<br>

::: {.fragment}
> **Portability lens**
> 
> - Same platform (DHIS2/CHAP) 
> - Same model pipelines
> - New target (consumption)  
:::

## The challenge: Why isn't this easy?

<br>

Case data and consumption data are different.

<br>

<div class="stretch-cols">

:::: {.columns}

::: {.column width="50%"}

::: {.fragment fragment-index=1 .minimal-box} 

<i class="fa-solid fa-database ch-icon" aria-hidden="true"></i> **Different Data Structures** 

Consumption data is ["messier"]{.highlight-blue}.

- Missing entries (e.g., "0" = no consumption, or "0" = data not entered?)
- Intermittency (infrequent demand).
- Inconsistent recording.
  
:::

:::

::: {.column width="50%"}

::: {.fragment fragment-index=2 .minimal-box}  

<i class="fa-solid fa-list-check ch-icon" aria-hidden="true"></i> **Different Metadata**

Consumption is affected by logistics.

- Lead times.
- Procurement cycles.
- Existing stock levels and stockouts.
  
:::

:::

::::

</div>

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>OUR APPROACH</h1>
</div>

## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/rqs.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

[What we are going to do]{.highlight-title}

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Apply the same CHAP morbidity models (no extra tuning) to product demand (malaria commodities, vaccines).

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Link forecasts to operations: evaluate both forecast accuracy and inventory impact.

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Build a portability matrix: when can we transfer a model?

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Design an implementation workflow for DHIS2/CHAP.

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Provide R scripts, CHAP YAML configs and sample datasets for full reproducibility.

:::

:::

::::

## Our experimental workflow

<br>

![](images/scope.png){style="width:80%; height:auto; "}

## Data sources

<br>

<div style="float:left; margin:0 1em 1em 0;">

::: {.table-custom}

| Data source        | Domain              | Geography / Sites                     | Coverage period        | Granularity                 |
|--------------------|---------------------|---------------------------------------|------------------------|-----------------------------|
| DHIS2              | Dengue cases        | Brazil (23 locations)                 | 2001 Jan ‚Äì 2017 Dec    | Monthly, subnational        |
|                    |                     | Laos (7 locations)                    | 2000 Jul ‚Äì 2013 Jun    | Monthly, subnational        |
|                    |                     | Paraguay (16 locations)               | 2012 Mar ‚Äì 2017 Dec    | Monthly, subnational        |
|                    |                     | Vietnam (19 locations)                | 2000 Jul ‚Äì 2017 Jun    | Monthly, subnational        |
| DHIS2              | Malaria incidence   | Rwanda (30 locations)                 | 2015 Jan ‚Äì 2024 Dec    | Monthly, subnational        |
| DHIS2 / LMIS       | Malaria commodities | Laos (11 products, 18 facilities)     | 2019 Feb ‚Äì 2021 Jun    | Monthly, subnational        |
| DHIS2 / LMIS       | Vaccine consumption | Laos (21 products, 10 facilities)     | 2021 Feb ‚Äì 2024 Jan    | Monthly, subnational        |
| DHIS2 Climate App  | Climate covariates  | All study settings                    | Study-specific         | Monthly, subnational        |
| | | | | |

:::

</div>


## Overview of the candidate models

```{r}
#| include: false

required_packages <- c(
  "tidyverse",
  "knitr",
  "kableExtra",
  "ggthemes",
  "patchwork",
  "tsibble",
  "feasts",
  "showtext",
  "viridis",
  "tidytext",
  "scales",
  "ggbreak",
  "ggrepel",
  'janitor'
)

new_packages <- required_packages[!required_packages %in% installed.packages()[, "Package"]]
if (length(new_packages)) {
  install.packages(new_packages)
}

invisible(lapply(required_packages, library, character.only = TRUE))

font_add_google("Inter")
showtext_auto()

```

```{r}
#| echo: false
#| cache: false

read_csv("tables/candidate_models.csv") |>
  kbl(
    format     = "html",
    escape     = FALSE, 
    table.attr = 'class="table-custom"',
    align      = "ll" 
  ) |>
  kable_styling(latex_options = "scale_down", font_size = 30)

```

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>FINDINGS</h1>
</div>


## Data exploration

```{r}
#| include: false

dengue_monthly <- read_csv('data/tidy_data/loas_dengue/historic_data.csv') |> 
  mutate(time_period = yearmonth(time_period),
         country = 'Laos') |> 
  select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)) |> 
  bind_rows(
    read_csv('data/tidy_data/paraguay_dengue/historic_data.csv') |> 
      mutate(time_period = yearmonth(time_period),
         country = 'Paraguay') |> 
      select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)),
    read_csv('data/tidy_data/brazil_dengue/historic_data.csv') |> 
      mutate(time_period = yearmonth(time_period),
         country = 'Brazil') |>
      select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)),
    read_csv('data/tidy_data/vietnam_dengue/historic_data.csv') |> 
      mutate(time_period = yearmonth(time_period),
         country = 'Vietnam') |> 
      select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)),
    read_csv('data/tidy_data/rwanda_malaria/rwanda_harmonized.csv') |> 
      mutate(time_period = yearmonth(time_period),
             country = 'Rwanda')) |> 
  as_tsibble(index = time_period,
             key = c(country, location)) |> 
  mutate(disease_cases = if_else(is.na(disease_cases), 0, disease_cases),
         case = 'Dengue cases')



rwanda_malaria <- read_csv('data/tidy_data/rwanda_malaria/rwanda_harmonized.csv') |> 
      mutate(time_period = yearmonth(time_period),
             country = 'Rwanda') |> 
  as_tsibble(index = time_period,
             key = c(country, location)) |> 
  mutate(disease_cases = if_else(is.na(disease_cases), 0, disease_cases),
         case = 'Malaria cases')


laos_logi <- read_csv('data/laos_logistics/laos_malaria_province.csv') |> 
  mutate(case = 'Malaria products') |> 
  bind_rows(
    read_csv('data/laos_logistics/laos_epi_cleaned.csv') |> 
      select(-store) |> 
      rename(province_code = org_unit) |> 
      mutate(case = 'Vaccine products')
  ) |> 
  mutate(time_period = yearmonth(time_period)) |> 
  rename(dispensed = disease_cases) |> 
  as_tsibble(index = time_period,
             key = c(province_code, product, location))

# idi vs cv^2

idi_stat <- function(x){
  nz <- which(x > 0); if (length(nz) < 2) return(NA_real_); mean(diff(nz))
}

cv2_pos <- function(x){
  y <- x[x > 0]; if (length(y) < 2) return(NA_real_); (sd(y)/mean(y))^2
}

dengue_idi_cv2 <- dengue_monthly  |> 
  as_tibble()  |>   
  group_by(country, location, case) |> 
  summarise(
    IDI = idi_stat(disease_cases),   
    CV2 = cv2_pos(disease_cases),
    .groups = "drop"
  )
  

laos_logi_idi_cv2 <- laos_logi  |> 
  as_tibble()  |>   
  mutate(country = 'Laos') |> 
  group_by(country, location, case) |> 
  summarise(
    IDI = idi_stat(dispensed),   
    CV2 = cv2_pos(dispensed),
    .groups = "drop"
  )

malaria_idi_cv2 <- rwanda_malaria |> 
  as_tibble() |> 
  group_by(country, location, case) |> 
  summarise(
    IDI = idi_stat(disease_cases),   
    CV2 = cv2_pos(disease_cases),
    .groups = "drop"
  )

idi_cv2 <- dengue_idi_cv2 |> 
  bind_rows(laos_logi_idi_cv2, malaria_idi_cv2)

```


```{r}
#| label: fig-ts_feat
#| echo: false
#| cache: true
#| fig-width: 16
#| fig-height: 10
#| fig-cap: "Classification of all morbidity and consumption series using the ln(CV¬≤) and ln(IDI) map. Each point represents a monthly series plotted on the logarithmic CV¬≤‚ÄìIDI scale."

threshold_x <- log(0.5)
threshold_y <- log(4/3)

idi_cv2 |>
  mutate(
    ln_IDI = log(IDI),
    ln_CV2 = log(CV2)
  ) |>
  ggplot(aes(x = ln_CV2, y = ln_IDI, colour = country, shape = country)) +
  
  geom_point(size = 2.5, stroke = 2, alpha = 0.8) +
  
  # geom_vline(xintercept = log(0.5), linetype = "dashed") +
  # geom_hline(yintercept = log(4/3), linetype = "dashed") +
  
  labs(
    x = "ln(CV¬≤)",
    y = "ln(IDI)",
    colour = "Country",
    shape = 'Country'
  ) +
  
  # annotate("text",
  #          x = threshold_x - 2,
  #          y = threshold_y - 1.2,
  #          label = "Smooth",
  #          colour = "grey15",
  #          size = 4
  # ) +
  # annotate("text",
  #          x = threshold_x + 2,
  #          y = threshold_y - 1.2,
  #          label = "Erratic",
  #          colour = "grey15",
  #          size = 4
  # ) +
  # annotate("text",
  #          x = threshold_x - 2,
  #          y = threshold_y + 2,
  #          label = "Intermittent",
  #          colour = "grey15",
  #          size = 4
  # ) +
  # annotate("text",
  #          x = threshold_x + 2,
  #          y = threshold_y + 2,
  #          label = "Lumpy",
  #          colour = "grey15",
  #          size = 4
  # ) +

  facet_wrap(~case, ncol = 2) +
  
  scale_colour_viridis_d(begin = 0.15, end = 0.85) +
  
  scale_shape_manual(values = 1:15) +
  
  theme_minimal(base_family = "Inter", base_size = 40) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "#6d8196", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  )


```


```{r}
#| echo: false


set_to_bold_min_html <- function(tbl, cols = 2:3, digits = 3) {
  df <- as.data.frame(tbl, stringsAsFactors = FALSE)
  cols <- cols[cols <= ncol(df)]
  if (length(cols) == 0) return(df)
  
  for (i in cols) {
    vec_num <- suppressWarnings(as.numeric(as.character(df[[i]])))
    
    if (all(is.na(vec_num))) {
      df[[i]] <- rep("", nrow(df))
      next
    }
    
    rounded <- round(vec_num, digits)
    best_mask <- !is.na(rounded) & rounded == min(rounded, na.rm = TRUE)
    
    fmt <- paste0("%.", digits, "f")
    formatted <- ifelse(is.na(rounded), "", sprintf(fmt, rounded))
    
    formatted[best_mask] <- paste0("<strong>", formatted[best_mask], "</strong>")
    
    df[[i]] <- formatted
  }
  
  return(df)
}

# thresholds 
idi_thr <- 4/3
cv2_thr <- 0.5

# set_to_bold()
set_to_bold <- function(tbl, cols = 2:13) {
  df <- as.data.frame(tbl, stringsAsFactors = FALSE)
  cols <- cols[cols <= ncol(df)]
  if (length(cols) == 0) return(df)

  for (i in cols) {
    vec_num <- suppressWarnings(as.numeric(as.character(df[[i]])))

    # skip non-numeric columns
    if (all(is.na(vec_num))) next

    # rounding used both for display and tie-detection
    rounded <- round(vec_num, 3)

    # decide which entries to bold
    if (i %in% 2:9) {
      # best = smallest value (e.g. MASE, QL)
      best_mask <- rounded == min(rounded, na.rm = TRUE)
    } else {
      # best = closest to 1 (e.g. coverage)
      best_mask <- abs(rounded - 0.9) == min(abs(rounded - 0.9), na.rm = TRUE)
    }

    best_mask[is.na(best_mask)] <- FALSE
    formatted <- ifelse(is.na(rounded), "", sprintf("%1.3f", rounded))
    formatted[best_mask] <- paste0("<strong>", formatted[best_mask], "</strong>")
    df[[i]] <- formatted
  }

  df
}


fc_acc <- read.csv('data/results/fc_evaluations_dengue_laos.csv') |> 
  bind_rows(read.csv('data/results/fc_evaluations_dengue_vietnam.csv'),
            read.csv('data/results/fc_evaluations_dengue_brazil.csv'),
            read.csv('data/results/fc_evaluations_dengue_paraguay.csv'),
            read.csv('data/results/fc_evaluations_epi_laos_logi.csv'),
            read.csv('data/results/fc_evaluations_malaria_laos_logi.csv'),
            read.csv('data/results/fc_evaluations_malaria_rwanda.csv')) |> 
  mutate(model = factor(model)) |> 
  select(forecast_start, model, country, item_id, case, MASE, `QuantileLoss.0.9.`, `Coverage.0.9.`) |>
  rename(
    quantile_loss_90 = `QuantileLoss.0.9.`,
    coverage_90      = `Coverage.0.9.`,
    location         = item_id,
    origin = forecast_start
  ) |>
  mutate(across(c(MASE, quantile_loss_90, coverage_90),
                ~ replace(.x, is.infinite(.x), NA_real_)),
         model = case_when(model == 'Auto ARIMA' ~ 'ARIMA',
                           model == 'Auto ARIMA Reg' ~ 'ARIMA Climate',
                           model == 'Linear Regression Reg' ~ 'Linear Regression Climate',
                           .default = model),
         case = case_when(case == 'Malaria Logistics' ~ 'Malaria Products',
                          case == 'EPI Logistics' ~ 'Vaccine Products',
                          case == 'Dengue' ~ 'Dengue Cases',
                          case == 'Malaria' ~ 'Malaria Cases',
                          .default = case))


fc_rank <- fc_acc |>
  filter(case %in% c('Malaria Products', 'Vaccine Products')) |> 
  left_join(idi_cv2 |> select(-case), by = c('country', 'location')) |> 
  janitor::clean_names() |> 
  mutate(ts_class = case_when(
      is.na(idi) | is.na(cv2)                         ~ "Unknown",
      idi  > idi_thr & cv2  > cv2_thr                 ~ "Lumpy",
      idi  > idi_thr & cv2  <= cv2_thr                ~ "Intermittent",
      idi  <= idi_thr & cv2 >  cv2_thr                ~ "Erratic",
      idi  <= idi_thr & cv2 <= cv2_thr                ~ "Smooth",
      TRUE                                            ~ "Unknown"
    ),
    ts_class = factor(ts_class, levels = c("Intermittent", "Lumpy", "Erratic", "Smooth", "Unknown"))) |>
  filter(ts_class != 'Unknown') |> 
  group_by(case, location) |> 
  mutate(mase_rank = min_rank(mase),
         quantile_loss_rank = min_rank(quantile_loss_90)) |> 
  ungroup() |> 
  group_by(case,ts_class, model) |>
  summarise(
    mase_rank = round(mean(mase_rank, na.rm = TRUE), 2),
    quantile_loss_rank = round(mean(quantile_loss_rank, na.rm = TRUE), 2),
    .groups = "drop"
  )

fc_case_summary <- fc_acc |>
  group_by(model, case) |>
  summarise(
    MASE       = mean(MASE, na.rm = TRUE),
    `Quantile Loss` = mean(quantile_loss_90, na.rm = TRUE),
    Coverage   = mean(coverage_90, na.rm = TRUE),
    .groups = "drop"
  ) 

```


## Average forecast method rankings

```{r}
#| label: fig-ts_rank_mase
#| cache: true
#| echo: false
#| fig-width: 16
#| fig-height: 10
#| fig-cap: "Average point forecast (MASE) ranks. Methods on the y-axis are ordered from best (top) to worst (bottom) based on their overall average rank across all domains. Lower ranks indicate better performance."

fc_acc |>
  group_by(origin, case, country, location) |> 
  mutate(rank = rank(MASE, ties.method = "min")) |>
  ungroup() |>
  group_by(case, model) |>
  summarise(avg_rank = mean(rank), .groups = "drop") |>
  mutate(model = fct_reorder(model, avg_rank, .fun = mean, .desc = TRUE)) |> 
   
  ggplot(aes(x = case, y = model, fill = avg_rank)) +
  geom_tile(color = "white", linewidth = 0.5) +
   geom_text(
     aes(
       label = round(avg_rank, 1),
       color = ifelse(avg_rank < 6, "black", "white") 
     ),
     fontface = "bold",  size = 10) +
   scale_color_identity() +
  scale_fill_viridis_c(direction = -1, name = "Average Rank") +
  # scale_x_discrete(position = "top") + 
  labs(
    y = "Method",
    x = 'Average MASE rank'
  ) +
   theme_minimal(base_family = "Inter", base_size = 40) +
   theme(
     panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
     panel.grid.major   = element_line(colour = "grey92", size = 0.35),
     panel.grid.minor   = element_blank(),
     axis.title         = element_text(face = "bold", colour = "#1a2b48"),
     axis.text          = element_text(colour = "#1a2b48"),
     legend.position    = "right",
     legend.title       = element_text(face = "bold", colour = "#1a2b48"),
     legend.text        = element_text(colour = "#1a2b48")
   )

```

## Average forecast method rankings

```{r}
#| label: fig-ts_rank_ql
#| cache: true
#| echo: false
#| fig-width: 16
#| fig-height: 10
#| fig-cap: "Average probabilistic forecast (quantile loss) ranks. Methods on the y-axis are ordered from best (top) to worst (bottom) based on their overall average rank across all domains. Lower ranks indicate better performance."

fc_acc |>
  group_by(origin, case, country, location) |> 
   mutate(rank = rank(quantile_loss_90, ties.method = "min")) |>
   ungroup() |>
   group_by(case, model) |>
   summarise(avg_rank = mean(rank), .groups = "drop") |>
   mutate(model = fct_reorder(model, avg_rank, .fun = mean, .desc = TRUE)) |> 
   
   ggplot(aes(x = case, y = model, fill = avg_rank)) +
   geom_tile(color = "white", linewidth = 0.5) +
   geom_text(
     aes(
       label = round(avg_rank, 1),
       color = ifelse(avg_rank < 6, "black", "white") 
     ),
     fontface = "bold",  size = 10) +
   scale_color_identity() +
   scale_fill_viridis_c(direction = -1, name = "Average Rank") +
   # scale_x_discrete(position = "top") + 
   labs(
     x = 'Average quantile loss rank',
     y = 'Method'
   ) +
   theme_minimal(base_family = "Inter", base_size = 40) +
   theme(
     panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
     panel.grid.major   = element_line(colour = "grey92", size = 0.35),
     panel.grid.minor   = element_blank(),
     axis.title         = element_text(face = "bold", colour = "#1a2b48"),
     axis.text          = element_text(colour = "#1a2b48"),
     legend.position    = "right",
     legend.title       = element_text(face = "bold", colour = "#1a2b48"),
     legend.text        = element_text(colour = "#1a2b48")
   )

```


## Overall inventory performance - Malaria products

```{r}
#| include: false

inventory_sim <- read_rds('data/results/inventory_sim.rds')

product_master <- read_csv('data/laos_logistics/laos_epi_cleaned.csv') |> 
  select(location, org_unit, product) |> 
  unique() |> 
  bind_rows(read_csv('data/laos_logistics/laos_malaria_province.csv') |> 
              rename(org_unit = province_code) |> 
              select(location, org_unit, product) |> 
              unique())


inv_metrics <- inventory_sim |> 
  group_by(case, country, location, model, target_csl) |> 
  slice(-1) |> 
  summarise(
    CSL = round(mean(met_demand, na.rm=TRUE), 1),
    stockout_rate = round(mean(stockout, na.rm=TRUE), 1),
    avg_inventory = round(mean(mean((opening_stock+closing_stock)/2, na.rm=TRUE), 1)),
    # avg_inventory = round(mean(if_else(order_qty >= 0.1,
    #                                     ((opening_stock+closing_stock)/2)/order_qty, NA_real_), 
    #                             na.rm=TRUE), 1),
    .groups        = "drop"
  ) |> 
  left_join(product_master, by = 'location') |> 
  mutate(model = case_when(model == 'Auto ARIMA' ~ 'ARIMA',
                           model == 'Auto ARIMA Reg' ~ 'ARIMA Climate',
                           model == 'Linear Regression Reg' ~ 'Linear Regression Climate',
                           .default = model),
         case = case_when(case == 'Malaria' ~ 'Malaria products',
                          case == 'EPI' ~ 'Vaccine products',
                          .default = case)) |> 
  mutate(model = if_else(model == 'Na\xefve', 'Naive', model)) |> 
  left_join(idi_cv2 |> select(-case), by = c('country', 'location')) |> 
  janitor::clean_names() |> 
  filter(target_csl != 'mean')

descriptive_summary <- inv_metrics |> 
  group_by(case, model, target_csl) |> 
  summarise(
    across(
      where(is.numeric),
      list(
        mean   = ~ mean(. , na.rm = TRUE)
        # median = ~ median(. , na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  )



highlight_models <- c("Random Forest", "ARIMA", "Mean", "ETS", "Auto EWARS", "INLA Baseline")

plot_data <- descriptive_summary |> 
  filter(model != 'sNaive')

label_data <- plot_data |>
  filter(model %in% highlight_models) |>
  group_by(case, model) |>
  filter(csl_mean == max(csl_mean)) |>
  ungroup()


all_models <- unique(plot_data$model)

model_colors <- setNames(rep("#d3d3d3", length(all_models)), all_models)
 
distinct_colors <- c(
  "Random Forest" = "#D55E00",  # Orange/Red
  "ARIMA"         = "#568203",  # Teal/Green
  "Mean"          = "#007BA7",  # Purple
  "ETS"           = "#c04657",  # Pink
  "Auto EWARS"    = "#750851",  # Green
  "INLA Baseline" = "#E6AB02"   # Yellow/Gold
)


model_colors[names(distinct_colors)] <- distinct_colors
```

```{r}
#| label: fig-inv_overall_malaria
#| cache: true
#| echo: false
#| fig-width: 16
#| fig-height: 8
#| fig-cap: "Inventory performance across malaria-product simulations using quantile-based order-up-to policies (q80‚Äìq97.5)."

plot_data |>
  filter(case == 'Malaria products') |> 
  ggplot(mapping = aes(x = avg_inventory_mean, y = csl_mean, group = model, color = model, shape = model)) +

  geom_line(
    linewidth = 0.8, 
    alpha = 0.8
  ) +

  geom_point(size = 2, alpha = 0.9, stroke = 1.5) +

  geom_text_repel(
    data = label_data |> filter(case == 'Malaria products'),
    aes(label = model),
    size = 8,
    fontface = "bold",
    nudge_y = Inf, 
    hjust = 0,
    direction = "x",
    box.padding = 0.5,
    segment.size = 0.4,
    segment.linetype = "dotted", 
    min.segment.length = 0,
    max.overlaps = Inf
  ) +
  
  # scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +
  
  labs(
    x = "Average Inventory", 
    y = "Achieved CSL",
    color = "Method",
    shape = "Method"
  ) +
  
  # facet_wrap(~case, ncol = 1, scales = 'free') +

  scale_color_manual(values = model_colors) +

  scale_shape_manual(values = 1:length(all_models)) +
  theme_minimal(base_family = "Inter", base_size = 30) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  ) 

```

## Overall inventory performance - Vaccine

```{r}
#| label: fig-inv_overall_vaccine
#| cache: true
#| echo: false
#| fig-width: 16
#| fig-height: 8
#| fig-cap: "Inventory performance across vaccine-product simulations using quantile-based order-up-to policies (q80‚Äìq97.5)."

plot_data |>
  filter(case != 'Malaria products') |> 
  ggplot(mapping = aes(x = avg_inventory_mean, y = csl_mean, group = model, color = model, shape = model)) +

  geom_line(
    linewidth = 0.8, 
    alpha = 0.8
  ) +

  geom_point(size = 2, alpha = 0.9, stroke = 1.5) +

  geom_text_repel(
    data = label_data |> filter(case != 'Malaria products'),
    aes(label = model),
    size = 8,
    fontface = "bold",
    nudge_y = Inf, 
    hjust = 0,
    direction = "x",
    box.padding = 0.5,
    segment.size = 0.4,
    segment.linetype = "dotted", 
    min.segment.length = 0,
    max.overlaps = Inf
  ) +
  
  # scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +
  
  labs(
    x = "Average Inventory", 
    y = "Achieved CSL",
    color = "Method",
    shape = "Method"
  ) +
  
  # facet_wrap(~case, ncol = 1, scales = 'free') +

  scale_color_manual(values = model_colors) +

  scale_shape_manual(values = 1:length(all_models)) +
  theme_minimal(base_family = "Inter", base_size = 30) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  ) 

```


## Execution scalability of all forecasting methods

```{r}
#| label: fig-portability
#| echo: false
#| cache: true
#| fig-width: 14
#| fig-height: 8
#| fig-cap: "Model portability metrics for all candidate forecasting methods, relative to the Mean method. Relative MASE and QL(0.9) are reported separately for malaria and vaccine products; values below 1 indicate improvement over the Mean method."


fc_rel <- read_rds("data/results/fc_rel.rds") |>
  select(-failures) |>
  pivot_longer(
    cols      = c(rel_mase, rel_quantile_loss_90),
    names_to  = "measure",
    values_to = "value"
  ) |>
  mutate(
    measure = recode(
      measure,
      rel_mase            = "Rel. MASE",
      rel_quantile_loss_90 = "Rel. QL(0.9)"
    ),
    measure = factor(measure, levels = c("Rel. MASE", "Rel. QL(0.9)"))
  ) |> 
  mutate(failure = if_else(model %in% c('ARIMA Climate', 'ARIMA Madagaskar'), 'Model Faliure', 'None'))

fc_rel |>
  mutate(model = factor(model)) |>
  ggplot(aes(
    x      = rel_running_time,
    y      = value,
    colour = failure,
    shape  = model
  )) +
  geom_point(
    # position = position_jitter(width = 0.03, height = 0.03),
    size     = 3,
    stroke   = 1
  ) +
  facet_grid(cols = vars(case), rows = vars(measure), scales = "free", switch = "y") +
  scale_colour_manual(
  values = c(
    "Model Faliure" = "#D55E00",  # red (failure)
    "None"          = "#009E73"   # green (no failure)
  )) +
  scale_shape_manual(values = 0:14) +
  labs(
    x = "Relative runtime (seconds per series and forecast origin)",
    y = NULL,
    colour = "Failure status",
    shape  = "Model"
  ) +
  theme_minimal(base_family = "Inter", base_size = 32) +
  theme(
    strip.placement      = "outside",
    strip.background.y   = element_blank(),
    strip.text.y.left    = element_text(
      face   = "bold",
      colour = "#1a2b48",
      size   = 28
    ),
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  ) 


```

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>LIVE DEMO</h1>
</div>

## Resources

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> [GitHub repo with all R codes and YML configurations](www.github.com)

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> [Documentation for Model Developers](https://dhis2-chap.github.io/chap-core/external_models/index.html)

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> [Running models through Chap](https://dhis2-chap.github.io/chap-core/external_models/running_models_in_chap.html)

<br>


<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> [Configure DHIS2 Modeling App and Chap Core](https://dhis2-chap.github.io/chap-core/modeling-app/running-chap-on-server.html)

<br>

::: {.callout-important appearance="simple"}

## Pay Attention

This demo shows how existing CHAP pipelines can run external forecasting and inventory models using external data, without modifying core workflows; therefore, some variables are renamed purely for schema compatibility (e.g., dispensed ‚Üí disease_cases), with no change to data meaning or modelling logic.

:::


## Minimalistic model example using R

::: {.panel-tabset}
## train.R

``` {.r}
# List packages
library(tidyverse)
library(fable)
library(tsibble)

# train models - # auto ets model 

train_chap <- function(csv_fn, model_fn) {
  df <- read_csv(csv_fn) |> 
    mutate(target = if_else(is.na(target), 0, target),
           time_period = yearmonth(time_period))
  
  df <- df |> distinct() |> 
    as_tsibble(index = time_period, key = location) |> 
    fill_gaps(target=0L, .full = TRUE)
  
  model <- df |> 
    model(ets = ETS(target))
  
  saveRDS(model, file=model_fn)
  
  print('train done')
  
}

args <- commandArgs(trailingOnly = TRUE)

if (length(args) == 2) {
  csv_fn <- args[1]
  model_fn <- args[2]
  
  train_chap(csv_fn, model_fn)
}# else {
#  stop("Usage: Rscript train.R <csv_fn> <model_fn>")
#}
```

## predict.R

``` {.r}
# Load required libraries
library(tidyverse)
library(fable)
library(tsibble)

# Define the predict function
predict_chap <- function(model_fn, historic_data_fn, future_climatedata_fn, predictions_fn) {
  
  # Load the pre-trained model structure
  model <- readRDS(model_fn)
  
  print('read model')
  
  # Load the complete historical data
  historic_df <- read_csv(historic_data_fn) |>
    mutate(target = if_else(is.na(target), 0, target),
           time_period = yearmonth(time_period)) |>
    as_tsibble(index = time_period, key = location) |> 
    fill_gaps(target=0L, .full = TRUE) 
  
  # Load the future data (covariates only)
  future_df <- read_csv(future_climatedata_fn) |>
    mutate(time_period = yearmonth(time_period)) |>
    as_tsibble(index = time_period, key = location)
  
  print('load_data')
  
  # Refit the model with all historic data and forecast
  
  model <- model |>
    refit(historic_df)
  
  y_pred <- model |>
    generate(new_data = future_df, bootstrap = FALSE, times = 1000) |> 
    mutate(.rep = as.integer(.rep)) |> 
    arrange(.rep) |> 
    pivot_wider(names_from = .rep, values_from = .sim, names_prefix = "sample_")
  
  print(y_pred)
  
  # saveRDS(model, file = model_fn)
  
  df_out <- future_df |>
    left_join(y_pred |>
                select(-.model) |> 
                mutate(across(starts_with("sample_"), ~ if_else(. < 0, 0, .))) |>
                rename_with(~ paste0("sample_", as.integer(str_extract(., "\\d+")) - 1), starts_with("sample_")),
              by = c('location', 'time_period')
    ) |>
    as_tibble() |>
    mutate(time_period = format(as.Date(time_period), "%Y-%m")) |> 
    select(time_period, location, starts_with("sample_"))
  
  
  print('made predictions')
  
  df_out |> print()
  
  
  write.csv(df_out, predictions_fn, row.names = FALSE)
  
  fname <- paste0("df_out_", format(Sys.time(), "%Y%m%d_%H%M%S"), predictions_fn)
  write_csv(y_pred, fname)
  
}

# --- Command Line Argument Handling (No change here) ---

args <- commandArgs(trailingOnly = TRUE)

if (length(args) == 4) {
  model_fn <- args[1]
  historic_data_fn <- args[2]
  future_climatedata_fn <- args[3]
  predictions_fn <- args[4]
  
  predict_chap(model_fn, historic_data_fn, future_climatedata_fn, predictions_fn)
}

# Inventory sim

source('quantile_based_inventory_sim.R')
```

## isolated_run.R

``` {.r}
source("ets-r/train.R")
source("ets-r/predict.R")

train_chap("ets-r/training_data.csv", 
           "ets-r/output/model.bin")

predict_chap("ets-r/output/model.bin", 
             "ets-r/historic_data.csv", 
             "ets-r/future_data.csv", 
             "ets-r/predictions.csv")
```

## MLproject.YML

``` {.yml}
name: ets-r

target: disease_cases

adapters: {'target': 'disease_cases'}

docker_env:
  image: ets-r:latest

entry_points:
  train:
    parameters:
      train_data: path
      model: path
    command: "Rscript train.R {train_data} {model}"
  predict:
    parameters:
      historic_data: path
      future_data: path
      model: str
      out_file: path
    command: "Rscript predict.R {model} {historic_data} {future_data} {out_file}"
```

## Dockerfile

``` {.txt}
FROM ghcr.io/dhis2-chap/docker_r_inla:master

RUN apt-get update
RUN apt-get install -y libharfbuzz-dev libfribidi-dev
RUN R -e 'r = getOption("repos"); r["CRAN"] = "http://cran.us.r-project.org"; options(repos = r); install.packages(c("tidyverse", "fable", "tsibble", "fabletools", "fpp3", "doParallel"), repos=c(getOption("repos"), dep=TRUE))'
```
:::

## Inventory policy: Order-upto-level with lost sales

::: {.panel-tabset}
## Prepare data

``` {.r}
# Inventory simulation

library(tidyverse)
library(tsibble)
library(doParallel)

set.seed(100)

# Read data ---------------------------------------------------------------

actual_df <- read.csv('data/laos/laos_epi_cleaned.csv') |> 
  rename(date = time_period,
         dispensed = disease_cases) |> 
  select(date, location, dispensed) |> 
  as_tibble()

pred_all <- read.csv('predictions.csv')

pred_master_df <- pred_all |> 
  rename(date = time_period) |> 
  mutate(across(starts_with("sample"), ~ pmax(., 0))) |> 
  rowwise() |> 
  mutate(
    mean = mean(c_across(starts_with("sample")), na.rm = TRUE) * 3,
    q80  = quantile(c_across(starts_with("sample")), probs = 0.80, na.rm = TRUE, names = FALSE),
    q85  = quantile(c_across(starts_with("sample")), probs = 0.85, na.rm = TRUE, names = FALSE),
    q90  = quantile(c_across(starts_with("sample")), probs = 0.90, na.rm = TRUE, names = FALSE),
    q95  = quantile(c_across(starts_with("sample")), probs = 0.95, na.rm = TRUE, names = FALSE),
    q975 = quantile(c_across(starts_with("sample")), probs = 0.975, na.rm = TRUE, names = FALSE)
  )  |> 
  ungroup() |> 
  select(date, location, mean, q80, q85, q90, q95, q975)

master_df <- pred_master_df |> 
  left_join(actual_df, by = c('date', 'location')) |> 
  mutate(date = as.Date(paste0(date, "-01")))
```

## Inventory function

``` {.r}
# Inventory function ------------------------------------------------------

master_long <- master_df |> 
  # filter(location == '0701larmany-0701 Xamnua-BCG diluent' & model == 'ETS') |> 
  pivot_longer(cols = c('mean', 'q80', 'q85', 'q90', 'q95', 'q975'), names_to = 'target_csl', values_to = 'quantity') |> 
  mutate(id = paste0(location, ':', target_csl))

id_list <- master_long |> 
  pull(id) |> 
  unique() 

# Register outer parallel backend with multiple cores

n_cores <- detectCores(logical = FALSE) - 1   # 16 physical cores ‚Äì 1 = 15
cl_outer <- makeCluster(n_cores)
registerDoParallel(cl_outer)

# parallel loop

system.time(inventory_sim_full <- foreach(i = id_list,
                                          .combine = 'rbind',
                                          .packages=c("doParallel", "foreach", "tidyverse", "tsibble", "fable")) %dopar% {
                                            
                                            # i <- id_list[1]
                                            
                                            df <- master_long |>
                                              filter(id == i) |> 
                                              group_by(location, target_csl) |> 
                                              arrange(date) |>
                                              mutate(
                                                target_stock = quantity,
                                                opening_stock = 0,
                                                received = 0,
                                                closing_stock = 0,
                                                order_qty = 0,
                                                delivery_due = NA,
                                                fixed_lead_time = 1
                                              )
                                            
                                            deliveries <- list()
                                            
                                            for (i in seq_len(nrow(df))) {
                                              today <- df$date[i]
                                              
                                              # Receive orders
                                              arrivals <- deliveries |>
                                                keep(~.x$arrival_date == today) |>
                                                map_dbl("amount") |>
                                                sum()
                                              
                                              df$opening_stock[i] <- if (i == 1) arrivals else df$closing_stock[i - 1] + arrivals
                                              actual <- df$dispensed[i]
                                              
                                              df$received[i] <- arrivals
                                              df$closing_stock[i] <- max(0, df$opening_stock[i] - actual)
                                              
                                              # Place order
                                              order_qty <- max(0, df$target_stock[i] - df$closing_stock[i])
                                              lead_time <- df$fixed_lead_time[i]
                                              delivery_date <- today %m+% months(lead_time)
                                              
                                              deliveries <- append(deliveries, list(list(arrival_date = delivery_date, amount = order_qty)))
                                              
                                              df$order_qty[i] <- order_qty
                                              df$delivery_due[i] <- delivery_date
                                            }
                                            
                                            
                                            inventory_sim <- df |>
                                              mutate(
                                                lost_sales = pmax(0, dispensed - pmin(dispensed, opening_stock)),
                                                met_demand = dispensed <= opening_stock,
                                                stockout = dispensed > opening_stock
                                              )
                                            
                                            inventory_sim
                                            
                                          })

# Stop outer cluster

stopCluster(cl_outer)


# Final data

write_csv(inventory_sim_full, 'inventory_sim.csv')


# Inventory value added ---------------------------------------------------

inv_metrics <- inventory_sim_full |> 
  group_by(location, target_csl) |> 
  slice(-1) |> 
  summarise(
    CSL = round(mean(met_demand, na.rm=TRUE), 1),
    stockout_rate = round(mean(stockout, na.rm=TRUE), 1),
    avg_inventory = round(mean(mean((opening_stock+closing_stock)/2, na.rm=TRUE), 1)),
    # avg_inventory = round(mean(if_else(order_qty >= 0.1,
    #                                     ((opening_stock+closing_stock)/2)/order_qty, NA_real_), 
    #                             na.rm=TRUE), 1),
    .groups        = "drop"
  )

fname <- paste0("df_out_", format(Sys.time(), "%Y%m%d_%H%M%S"), 'inventory.csv')
write_csv(inv_metrics, fname)
```


:::

## Running models through Chap (docker + WSL)

<br>


<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Connect with CHAP Core

``` {.r}
cd chap-core/

source .venv/bin/activate
```

<br> 

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Create docker image

``` {.r}
cd /mnt/d/GIT/dhis2_demo/ets-r

docker build -t ets-r:latest .

# Return to CHAP Core

cd ~

cd chap-core/
```

<br>

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Run CHAP evaluation

``` {.r}
chap evaluate --model-name /mnt/d/GIT/dhis2_demo/ets-r --dataset-csv /mnt/d/GIT/dhis2_demo/ets-r/data/laos/laos_epi_cleaned.csv
```


## Any questions or thoughts? üí¨ 

![](images/follow_us.png){fig-align="center"}




