---
format: 
  revealjs:
    slide-number: c/t
    width: 1920
    height: 1080
    logo: "images/logo.png"
    footer: "[From Cases to Consumption: Evaluating the portability of climate informed forecasting methods for public health supply chains](https://chamara7h.github.io/talks/)"
    css: theme.css
    echo: true
execute:
  warning: false
  echo: false
header-includes:
  - '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'
---   

# {.title-slide background-image="images/cover.png" background-size="cover"}

<div class="logo-container">
  <img src="images/cardiff_logo.png" alt="Cardiff University Logo">
  <img src="images/logo.png" alt="Data Lab Logo">
  <img src="images/uio_HISP.svg" alt="HISP UIO Logo">
  <img src="images/DHIS2_logo.svg" alt="DHIS2 Logo">
  <img src="images/wgss.png" alt="WGSSS Logo">
  <img src="images/ukri.png" alt="UKRI Logo">
</div>

<div class="title-slide">
  <h1>From Cases to Consumption</h1>
  <h2>Evaluating Forecasting Model Portability for Public-Health Supply Chains</h2>
  <p class="author">Harsha Halgamuwe Hewage, Bahman Rostami-Tabar, Geir Kjetil Ferkingstad Sandve, Breno Horsth</p>
  <p class="author">Data Lab for Social Good Research Group in collaboration with HISP Centre, University of Oslo</p>
  <p class="date">2026/01/15</p>
</div>

## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/outline.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

<br>

<br>

[Outline]{.highlight-title}

::: {.step data-step="01"}
<div class="step-content">
  <h3>Background</h3>
</div>
::: 

::: {.step data-step="02"}
<div class="step-content">
  <h3>The fundamental question</h3>
</div>
:::

::: {.step data-step="03"}
<div class="step-content">
  <h3>What we are going to do</h3>
</div>
:::

::: {.step data-step="04"}
<div class="step-content">
  <h3>Our initial scope</h3>
</div>
:::

::: {.step data-step="05"}
<div class="step-content">
  <h3>What did we find</h3>
</div>
:::

::: {.step data-step="06"}
<div class="step-content">
  <h3>What [NEXT?]{.highlight-blue}</h3>
</div>
:::

:::

::::

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>BACKGROUND</h1>
</div>

## {}

:::: {.columns}

::: {.column width="40%"}
![](images/background.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}
[The Problem: A tale of two data streams]{.highlight-title}

<br>

Health supply chains are struggling with forecasting at sub-national/ facility level.

- Operational realities: Incomplete records, irregular orders, frequent manual adjustments.

- This masks true demand and leads to a cycle of...

- Persistent, critical stockouts üìâ.

::: {.fragment fragment-index=1}

<br>

[But... we have a success story.]{.highlight-blue-big}

<br>

Platforms like [DHIS2]{.highlight-blue} and [CHAP]{.highlight-blue} have robust, high-performing models for forecasting disease cases (morbidity).

:::

:::

::::


## {}

:::: {.columns}

::: {.column width="40%"}
![](images/dhis2.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}
[What is DHIS2 and CHAP?]{.highlight-title}

<br>

::: {.fragment fragment-index=1}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> DHIS2 (District Health Information Software 2) is a free, open-source, web-based health information platform.

:::

<br>

::: {.fragment fragment-index=2}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> It is the world‚Äôs largest Health Management Information System (HMIS), used by Ministries of Health in over 80 countries.

:::

<br>

::: {.fragment fragment-index=3}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> CHAP stands for the Climate Health Analytics Platform.

:::

<br>

::: {.fragment fragment-index=4}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> CHAP is a predictive modelling layer integrated within DHIS2, designed to support climate-informed disease forecasting and early warning.

:::

:::

::::

## The fundemental question

<br>

‚úÖ We're good at forecasting cases (e.g., malaria).

<br>

‚ùå We're struggling with forecasting consumption (e.g., antimalarials) at sub-national level.

<br>

::: {.fragment}
[Can the same CHAP morbidity models and pipelines be *ported* to health commodity demand and inventory decisions?]{.highlight-blue-big} 
:::

<br>

::: {.fragment}
> **Portability lens**
> 
> - Same platform (DHIS2/CHAP) 
> - Same model pipelines
> - New target (consumption)  
:::

## The challenge: Why isn't this easy?

<br>

Case data and consumption data are different.

<br>

<div class="stretch-cols">

:::: {.columns}

::: {.column width="50%"}

::: {.fragment fragment-index=1 .minimal-box} 

<i class="fa-solid fa-database ch-icon" aria-hidden="true"></i> **Different Data Structures** 

Consumption data is ["messier"]{.highlight-blue}.

- Missing entries (e.g., "0" = no consumption, or "0" = data not entered?)
- Intermittency (infrequent demand).
- Inconsistent recording.
  
:::

:::

::: {.column width="50%"}

::: {.fragment fragment-index=2 .minimal-box}  

<i class="fa-solid fa-list-check ch-icon" aria-hidden="true"></i> **Different Metadata**

Consumption is affected by logistics.

- Lead times.
- Procurement cycles.
- Existing stock levels and stockouts.
  
:::

:::

::::

</div>

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>OUR APPROACH</h1>
</div>

## {} 

:::: {.columns}

::: {.column width="40%"}
![](images/rqs.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="57.5%"}

[What we are going to do]{.highlight-title}

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Apply the same CHAP morbidity models (no extra tuning) to product demand (malaria commodities, vaccines).

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Link forecasts to operations: evaluate both forecast accuracy and inventory impact.

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Build a portability matrix: when can we transfer a model?

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Design an implementation workflow for DHIS2/CHAP.

:::

<br>

::: {.fragment}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Provide R scripts, CHAP YAML configs and sample datasets for full reproducibility.

:::

:::

::::

## Our experimental workflow

<br>

![](images/scope.png){style="width:80%; height:auto; "}

## Overview of the candidate models

```{r}
#| include: false

required_packages <- c(
  "tidyverse",
  "knitr",
  "kableExtra",
  "ggthemes",
  "patchwork",
  "tsibble",
  "feasts",
  "showtext",
  "viridis",
  "tidytext",
  "scales",
  "ggbreak",
  "ggrepel"
)

new_packages <- required_packages[!required_packages %in% installed.packages()[, "Package"]]
if (length(new_packages)) {
  install.packages(new_packages)
}

invisible(lapply(required_packages, library, character.only = TRUE))

font_add_google("Inter")
showtext_auto()

```

```{r}
#| echo: false
#| cache: false

read_csv("tables/candidate_models.csv") |>
  kbl(
    format     = "html",
    escape     = FALSE, 
    table.attr = 'class="table-custom"',
    align      = "ll" 
  ) |>
  kable_styling(latex_options = "scale_down", font_size = 30)

```

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>FINDINGS</h1>
</div>


## Data exploration

```{r}
#| include: false

dengue_monthly <- read_csv('data/tidy_data/loas_dengue/historic_data.csv') |> 
  mutate(time_period = yearmonth(time_period),
         country = 'Laos') |> 
  select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)) |> 
  bind_rows(
    read_csv('data/tidy_data/paraguay_dengue/historic_data.csv') |> 
      mutate(time_period = yearmonth(time_period),
         country = 'Paraguay') |> 
      select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)),
    read_csv('data/tidy_data/brazil_dengue/historic_data.csv') |> 
      mutate(time_period = yearmonth(time_period),
         country = 'Brazil') |>
      select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)),
    read_csv('data/tidy_data/vietnam_dengue/historic_data.csv') |> 
      mutate(time_period = yearmonth(time_period),
         country = 'Vietnam') |> 
      select(-c(`...1`, parent, E, month, ID_year, ID_spat, Cases)),
    read_csv('data/tidy_data/rwanda_malaria/rwanda_harmonized.csv') |> 
      mutate(time_period = yearmonth(time_period),
             country = 'Rwanda')) |> 
  as_tsibble(index = time_period,
             key = c(country, location)) |> 
  mutate(disease_cases = if_else(is.na(disease_cases), 0, disease_cases),
         case = 'Dengue cases')



rwanda_malaria <- read_csv('data/tidy_data/rwanda_malaria/rwanda_harmonized.csv') |> 
      mutate(time_period = yearmonth(time_period),
             country = 'Rwanda') |> 
  as_tsibble(index = time_period,
             key = c(country, location)) |> 
  mutate(disease_cases = if_else(is.na(disease_cases), 0, disease_cases),
         case = 'Malaria cases')


laos_logi <- read_csv('data/laos_logistics/laos_malaria_province.csv') |> 
  mutate(case = 'Malaria products') |> 
  bind_rows(
    read_csv('data/laos_logistics/laos_epi_cleaned.csv') |> 
      select(-store) |> 
      rename(province_code = org_unit) |> 
      mutate(case = 'Vaccine products')
  ) |> 
  mutate(time_period = yearmonth(time_period)) |> 
  rename(dispensed = disease_cases) |> 
  as_tsibble(index = time_period,
             key = c(province_code, product, location))

# idi vs cv^2

idi_stat <- function(x){
  nz <- which(x > 0); if (length(nz) < 2) return(NA_real_); mean(diff(nz))
}

cv2_pos <- function(x){
  y <- x[x > 0]; if (length(y) < 2) return(NA_real_); (sd(y)/mean(y))^2
}

dengue_idi_cv2 <- dengue_monthly  |> 
  as_tibble()  |>   
  group_by(country, location, case) |> 
  summarise(
    IDI = idi_stat(disease_cases),   
    CV2 = cv2_pos(disease_cases),
    .groups = "drop"
  )
  

laos_logi_idi_cv2 <- laos_logi  |> 
  as_tibble()  |>   
  mutate(country = 'Laos') |> 
  group_by(country, location, case) |> 
  summarise(
    IDI = idi_stat(dispensed),   
    CV2 = cv2_pos(dispensed),
    .groups = "drop"
  )

malaria_idi_cv2 <- rwanda_malaria |> 
  as_tibble() |> 
  group_by(country, location, case) |> 
  summarise(
    IDI = idi_stat(disease_cases),   
    CV2 = cv2_pos(disease_cases),
    .groups = "drop"
  )

idi_cv2 <- dengue_idi_cv2 |> 
  bind_rows(laos_logi_idi_cv2, malaria_idi_cv2)

```


```{r}
#| label: fig-ts_feat
#| echo: false
#| cache: true
#| fig-width: 16
#| fig-height: 10
#| fig-cap: "Classification of all morbidity and consumption series using the ln(CV¬≤) and ln(IDI) map. Each point represents a monthly series plotted on the logarithmic CV¬≤‚ÄìIDI scale."

threshold_x <- log(0.5)
threshold_y <- log(4/3)

idi_cv2 |>
  mutate(
    ln_IDI = log(IDI),
    ln_CV2 = log(CV2)
  ) |>
  ggplot(aes(x = ln_CV2, y = ln_IDI, colour = country, shape = country)) +
  
  geom_point(size = 2, stroke = 1.5, alpha = 0.8) +
  
  # geom_vline(xintercept = log(0.5), linetype = "dashed") +
  # geom_hline(yintercept = log(4/3), linetype = "dashed") +
  
  labs(
    x = "ln(CV¬≤)",
    y = "ln(IDI)",
    colour = "Country",
    shape = 'Country'
  ) +
  
  # annotate("text",
  #          x = threshold_x - 2,
  #          y = threshold_y - 1.2,
  #          label = "Smooth",
  #          colour = "grey15",
  #          size = 4
  # ) +
  # annotate("text",
  #          x = threshold_x + 2,
  #          y = threshold_y - 1.2,
  #          label = "Erratic",
  #          colour = "grey15",
  #          size = 4
  # ) +
  # annotate("text",
  #          x = threshold_x - 2,
  #          y = threshold_y + 2,
  #          label = "Intermittent",
  #          colour = "grey15",
  #          size = 4
  # ) +
  # annotate("text",
  #          x = threshold_x + 2,
  #          y = threshold_y + 2,
  #          label = "Lumpy",
  #          colour = "grey15",
  #          size = 4
  # ) +

  facet_wrap(~case, ncol = 2) +
  
  scale_colour_viridis_d(begin = 0.15, end = 0.85) +
  
  scale_shape_manual(values = 1:15) +
  
  theme_minimal(base_family = "Inter", base_size = 32) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "#6d8196", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  )


```


```{r}
#| echo: false


set_to_bold_min_html <- function(tbl, cols = 2:3, digits = 3) {
  df <- as.data.frame(tbl, stringsAsFactors = FALSE)
  cols <- cols[cols <= ncol(df)]
  if (length(cols) == 0) return(df)
  
  for (i in cols) {
    vec_num <- suppressWarnings(as.numeric(as.character(df[[i]])))
    
    if (all(is.na(vec_num))) {
      df[[i]] <- rep("", nrow(df))
      next
    }
    
    rounded <- round(vec_num, digits)
    best_mask <- !is.na(rounded) & rounded == min(rounded, na.rm = TRUE)
    
    fmt <- paste0("%.", digits, "f")
    formatted <- ifelse(is.na(rounded), "", sprintf(fmt, rounded))
    
    formatted[best_mask] <- paste0("<strong>", formatted[best_mask], "</strong>")
    
    df[[i]] <- formatted
  }
  
  return(df)
}

# thresholds 
idi_thr <- 4/3
cv2_thr <- 0.5

# set_to_bold()
set_to_bold <- function(tbl, cols = 2:13) {
  df <- as.data.frame(tbl, stringsAsFactors = FALSE)
  cols <- cols[cols <= ncol(df)]
  if (length(cols) == 0) return(df)

  for (i in cols) {
    vec_num <- suppressWarnings(as.numeric(as.character(df[[i]])))

    # skip non-numeric columns
    if (all(is.na(vec_num))) next

    # rounding used both for display and tie-detection
    rounded <- round(vec_num, 3)

    # decide which entries to bold
    if (i %in% 2:9) {
      # best = smallest value (e.g. MASE, QL)
      best_mask <- rounded == min(rounded, na.rm = TRUE)
    } else {
      # best = closest to 1 (e.g. coverage)
      best_mask <- abs(rounded - 0.9) == min(abs(rounded - 0.9), na.rm = TRUE)
    }

    best_mask[is.na(best_mask)] <- FALSE
    formatted <- ifelse(is.na(rounded), "", sprintf("%1.3f", rounded))
    formatted[best_mask] <- paste0("<strong>", formatted[best_mask], "</strong>")
    df[[i]] <- formatted
  }

  df
}


fc_acc <- read.csv('data/results/fc_evaluations_dengue_laos.csv') |> 
  bind_rows(read.csv('data/results/fc_evaluations_dengue_vietnam.csv'),
            read.csv('data/results/fc_evaluations_dengue_brazil.csv'),
            read.csv('data/results/fc_evaluations_dengue_paraguay.csv'),
            read.csv('data/results/fc_evaluations_epi_laos_logi.csv'),
            read.csv('data/results/fc_evaluations_malaria_laos_logi.csv'),
            read.csv('data/results/fc_evaluations_malaria_rwanda.csv')) |> 
  mutate(model = factor(model)) |> 
  select(forecast_start, model, country, item_id, case, MASE, `QuantileLoss.0.9.`, `Coverage.0.9.`) |>
  rename(
    quantile_loss_90 = `QuantileLoss.0.9.`,
    coverage_90      = `Coverage.0.9.`,
    location         = item_id,
    origin = forecast_start
  ) |>
  mutate(across(c(MASE, quantile_loss_90, coverage_90),
                ~ replace(.x, is.infinite(.x), NA_real_)),
         model = case_when(model == 'Auto ARIMA' ~ 'ARIMA',
                           model == 'Auto ARIMA Reg' ~ 'ARIMA Climate',
                           model == 'Linear Regression Reg' ~ 'Linear Regression Climate',
                           .default = model),
         case = case_when(case == 'Malaria Logistics' ~ 'Malaria Products',
                          case == 'EPI Logistics' ~ 'Vaccine Products',
                          case == 'Dengue' ~ 'Dengue Cases',
                          case == 'Malaria' ~ 'Malaria Cases',
                          .default = case))


fc_rank <- fc_acc |>
  filter(case %in% c('Malaria Products', 'Vaccine Products')) |> 
  left_join(idi_cv2 |> select(-case), by = c('country', 'location')) |> 
  janitor::clean_names() |> 
  mutate(ts_class = case_when(
      is.na(idi) | is.na(cv2)                         ~ "Unknown",
      idi  > idi_thr & cv2  > cv2_thr                 ~ "Lumpy",
      idi  > idi_thr & cv2  <= cv2_thr                ~ "Intermittent",
      idi  <= idi_thr & cv2 >  cv2_thr                ~ "Erratic",
      idi  <= idi_thr & cv2 <= cv2_thr                ~ "Smooth",
      TRUE                                            ~ "Unknown"
    ),
    ts_class = factor(ts_class, levels = c("Intermittent", "Lumpy", "Erratic", "Smooth", "Unknown"))) |>
  filter(ts_class != 'Unknown') |> 
  group_by(case, location) |> 
  mutate(mase_rank = min_rank(mase),
         quantile_loss_rank = min_rank(quantile_loss_90)) |> 
  ungroup() |> 
  group_by(case,ts_class, model) |>
  summarise(
    mase_rank = round(mean(mase_rank, na.rm = TRUE), 2),
    quantile_loss_rank = round(mean(quantile_loss_rank, na.rm = TRUE), 2),
    .groups = "drop"
  )

fc_case_summary <- fc_acc |>
  group_by(model, case) |>
  summarise(
    MASE       = mean(MASE, na.rm = TRUE),
    `Quantile Loss` = mean(quantile_loss_90, na.rm = TRUE),
    Coverage   = mean(coverage_90, na.rm = TRUE),
    .groups = "drop"
  ) 

```


## Average forecast model rankings

```{r}
#| label: fig-ts_rank
#| cache: true
#| echo: false
#| out.width: "50%"
#| fig-cap: "Average point forecast (MASE) and probabilistic (quantile loss) ranks. Methods on the y-axis are ordered from best (top) to worst (bottom) based on their overall average rank across all domains. Lower ranks indicate better performance."

p1 <- fc_acc |>
  group_by(origin, case, country, location) |> 
  mutate(rank = rank(MASE, ties.method = "min")) |>
  ungroup() |>
  group_by(case, model) |>
  summarise(avg_rank = mean(rank), .groups = "drop") |>
  mutate(model = fct_reorder(model, avg_rank, .fun = mean, .desc = TRUE)) |> 
   
  ggplot(aes(x = case, y = model, fill = avg_rank)) +
  geom_tile(color = "white", linewidth = 0.5) +
   geom_text(
     aes(
       label = round(avg_rank, 1),
       color = ifelse(avg_rank < 6, "black", "white") 
     ),
     fontface = "bold",  size = 3.5) +
   scale_color_identity() +
  scale_fill_viridis_c(direction = -1, name = "Average Rank") +
  # scale_x_discrete(position = "top") + 
  labs(
    y = "Method",
    x = 'Average MASE rank'
  ) +
   theme_minimal(base_family = "Inter", base_size = 16) +
   theme(
     panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
     panel.grid.major   = element_line(colour = "grey92", size = 0.35),
     panel.grid.minor   = element_blank(),
     axis.title         = element_text(face = "bold", colour = "#1a2b48"),
     axis.text          = element_text(colour = "#1a2b48"),
     legend.position    = "none",
     legend.title       = element_text(face = "bold", colour = "#1a2b48"),
     legend.text        = element_text(colour = "#1a2b48")
   )
 
 
p2 <- fc_acc |>
  group_by(origin, case, country, location) |> 
   mutate(rank = rank(quantile_loss_90, ties.method = "min")) |>
   ungroup() |>
   group_by(case, model) |>
   summarise(avg_rank = mean(rank), .groups = "drop") |>
   mutate(model = fct_reorder(model, avg_rank, .fun = mean, .desc = TRUE)) |> 
   
   ggplot(aes(x = case, y = model, fill = avg_rank)) +
   geom_tile(color = "white", linewidth = 0.5) +
   geom_text(
     aes(
       label = round(avg_rank, 1),
       color = ifelse(avg_rank < 6, "black", "white") 
     ),
     fontface = "bold",  size = 3.5) +
   scale_color_identity() +
   scale_fill_viridis_c(direction = -1, name = "Average Rank") +
   # scale_x_discrete(position = "top") + 
   labs(
     x = 'Average quantile loss rank',
     y = NULL
   ) +
   theme_minimal(base_family = "Inter", base_size = 16) +
   theme(
     panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
     panel.grid.major   = element_line(colour = "grey92", size = 0.35),
     panel.grid.minor   = element_blank(),
     axis.title         = element_text(face = "bold", colour = "#1a2b48"),
     axis.text          = element_text(colour = "#1a2b48"),
     legend.position    = "right",
     legend.title       = element_text(face = "bold", colour = "#1a2b48"),
     legend.text        = element_text(colour = "#1a2b48")
   )

(p1 | p2) +
  plot_layout(guides = "collect") +
  plot_annotation(theme = theme(legend.position = "right"))

```

## Point forecast accuracy distribution

```{r}
#| label: fig-fc_dist_point
#| cache: true
#| echo: false
#| out.width: "80%"
#| fig-cap: "Distribution of MASE across morbidity and supply chain datasets. Methods are sorted by median error, with the best-performing methods positioned at the bottom of each facet."

p1 <- fc_acc |> 
  filter(case == 'Dengue Cases') |> 
  mutate(model_ordered = fct_reorder(model, MASE, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = MASE, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(trans = "pseudo_log", breaks = c(0, 1, 5, 10, 100)) +
  scale_y_reordered() +
  labs(
    x = "MASE",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48")
  ) 

p2 <- fc_acc |> 
  filter(case == 'Malaria Cases') |> 
  mutate(model_ordered = fct_reorder(model, MASE, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = MASE, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(trans = "pseudo_log", breaks = c(0, 1, 5, 10, 100)) +
  scale_y_reordered() +
  labs(
    x = "MASE",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48")
  ) 

p3 <- fc_acc |> 
  filter(case == 'Malaria Products') |> 
  mutate(model_ordered = fct_reorder(model, MASE, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = MASE, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(trans = "pseudo_log", breaks = c(0, 1, 5, 10, 100)) +
  scale_y_reordered() +
  labs(
    x = "MASE",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48")
  ) 

p4 <- fc_acc |> 
  filter(case == 'Vaccine Products') |> 
  mutate(model_ordered = fct_reorder(model, MASE, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = MASE, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(trans = "pseudo_log", breaks = c(0, 1, 5, 10, 100)) +
  scale_y_reordered() +
  labs(
    x = "MASE",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48")
  ) 

(p1 | p2) / (p3 | p4) +
  plot_layout(guides = "collect")

```

## Probabilistic forecast accuracy distribution

```{r}
#| label: fig-fc_dist_prob
#| cache: true
#| echo: false
#| out.width: "80%"
#| fig-cap: "Distribution of quantile loss (q90) across morbidity and supply chain datasets. Methods are sorted by median error, with the best-performing methods positioned at the bottom of each facet. The x-axis employs an inverse hyperbolic sine ($asinh$) transformation to visualize extreme outliers."

my_breaks <- function(x) {
  max_val <- max(x, na.rm = TRUE)
  
  if (max_val > 1000000) { 
    # Range for Malaria Products (huge numbers)
    return(c(0, 300000, 600000, 900000, 1200000))
  } else if (max_val > 100000) { 
    # Range for Dengue/Malaria Cases (medium numbers)
    return(c(0, 50000, 100000, 150000))
  } else { 
    # Range for Vaccines (small numbers)
    return(c(0, 2000, 4000, 6000))
  }
}

p1a <- fc_acc |> 
  filter(case == 'Dengue Cases') |> 
  mutate(model_ordered = fct_reorder(model, quantile_loss_90, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = quantile_loss_90, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(
    trans = "asinh", 
    labels = label_number(scale_cut = cut_short_scale()),
    n.breaks = 6 
  ) +
  scale_y_reordered() +
  labs(
    x = "Quantile Loss (q90)",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  ) 

p2a <- fc_acc |> 
  filter(case == 'Malaria Cases') |> 
  mutate(model_ordered = fct_reorder(model, quantile_loss_90, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = quantile_loss_90, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(
    trans = "asinh", 
    labels = label_number(scale_cut = cut_short_scale()),
    n.breaks = 6 
  ) +
  scale_y_reordered() +
  labs(
    x = "Quantile Loss (q90)",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

p3a <- fc_acc |> 
  filter(case == 'Malaria Products') |> 
  mutate(model_ordered = fct_reorder(model, quantile_loss_90, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = quantile_loss_90, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(
    trans = "asinh", 
    labels = label_number(scale_cut = cut_short_scale()),
    n.breaks = 6 
  ) +
  scale_y_reordered() +
  labs(
    x = "Quantile Loss (q90)",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  ) 

p4a <- fc_acc |> 
  filter(case == 'Vaccine Products') |> 
  mutate(model_ordered = fct_reorder(model, quantile_loss_90, .fun = median, .desc = TRUE)) |>
  ggplot(aes(x = quantile_loss_90, y = model_ordered)) +
  geom_boxplot(outlier.shape = 1, outlier.alpha = 0.5) +
  facet_wrap(~case, scales = "free", ncol = 2) +
  scale_x_continuous(
    trans = "asinh", 
    labels = label_number(scale_cut = cut_short_scale()),
    n.breaks = 6 
  ) +
  scale_y_reordered() +
  labs(
    x = "Quantile Loss (q90)",
    y = "Method"
  ) +
  theme_minimal(base_family = "Inter", base_size = 16) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

(p1a | p2a) / (p3a | p4a) +
  plot_layout(guides = "collect")

```


## Overall inventory performance

```{r}
#| include: false

inventory_sim <- read_rds('data/results/inventory_sim.rds')

product_master <- read_csv('data/laos_logistics/laos_epi_cleaned.csv') |> 
  select(location, org_unit, product) |> 
  unique() |> 
  bind_rows(read_csv('data/laos_logistics/laos_malaria_province.csv') |> 
              rename(org_unit = province_code) |> 
              select(location, org_unit, product) |> 
              unique())


inv_metrics <- inventory_sim |> 
  group_by(case, country, location, model, target_csl) |> 
  slice(-1) |> 
  summarise(
    CSL = round(mean(met_demand, na.rm=TRUE), 1),
    stockout_rate = round(mean(stockout, na.rm=TRUE), 1),
    avg_inventory = round(mean(mean((opening_stock+closing_stock)/2, na.rm=TRUE), 1)),
    # avg_inventory = round(mean(if_else(order_qty >= 0.1,
    #                                     ((opening_stock+closing_stock)/2)/order_qty, NA_real_), 
    #                             na.rm=TRUE), 1),
    .groups        = "drop"
  ) |> 
  left_join(product_master, by = 'location') |> 
  mutate(model = case_when(model == 'Auto ARIMA' ~ 'ARIMA',
                           model == 'Auto ARIMA Reg' ~ 'ARIMA Climate',
                           model == 'Linear Regression Reg' ~ 'Linear Regression Climate',
                           .default = model),
         case = case_when(case == 'Malaria' ~ 'Malaria products',
                          case == 'EPI' ~ 'Vaccine products',
                          .default = case)) |> 
  mutate(model = if_else(model == 'Na\xefve', 'Naive', model)) |> 
  left_join(idi_cv2 |> select(-case), by = c('country', 'location')) |> 
  janitor::clean_names() |> 
  filter(target_csl != 'mean')

descriptive_summary <- inv_metrics |> 
  group_by(case, model, target_csl) |> 
  summarise(
    across(
      where(is.numeric),
      list(
        mean   = ~ mean(. , na.rm = TRUE)
        # median = ~ median(. , na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  )



highlight_models <- c("Random Forest", "ARIMA", "Mean", "ETS", "Auto EWARS", "INLA Baseline")

plot_data <- descriptive_summary |> 
  filter(model != 'sNaive')

label_data <- plot_data |>
  filter(model %in% highlight_models) |>
  group_by(case, model) |>
  filter(csl_mean == max(csl_mean)) |>
  ungroup()


all_models <- unique(plot_data$model)

model_colors <- setNames(rep("#d3d3d3", length(all_models)), all_models)
 
distinct_colors <- c(
  "Random Forest" = "#D55E00",  # Orange/Red
  "ARIMA"         = "#568203",  # Teal/Green
  "Mean"          = "#007BA7",  # Purple
  "ETS"           = "#c04657",  # Pink
  "Auto EWARS"    = "#750851",  # Green
  "INLA Baseline" = "#E6AB02"   # Yellow/Gold
)


model_colors[names(distinct_colors)] <- distinct_colors
```


```{r}
#| label: fig-inv_overall
#| cache: true
#| echo: false
#| fig-width: 14
#| fig-height: 8
#| fig-cap: "Inventory performance across malaria-product and vaccine-product simulations using quantile-based order-up-to policies (q80‚Äìq97.5)."

plot_data |>
  ggplot(mapping = aes(x = avg_inventory_mean, y = csl_mean, group = model, color = model, shape = model)) +

  geom_line(
    linewidth = 0.8, 
    alpha = 0.8
  ) +

  geom_point(size = 2, alpha = 0.9, stroke = 1.5) +

  geom_text_repel(
    data = label_data,
    aes(label = model),
    size = 7,
    fontface = "bold",
    nudge_y = Inf, 
    hjust = 0,
    direction = "x",
    box.padding = 0.5,
    segment.size = 0.4,
    segment.linetype = "dotted", 
    min.segment.length = 0,
    max.overlaps = Inf
  ) +
  
  # scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +
  
  labs(
    x = "Average Inventory", 
    y = "Achieved CSL",
    color = "Method",
    shape = "Method"
  ) +
  
  facet_wrap(~case, ncol = 1, scales = 'free') +

  scale_color_manual(values = model_colors) +

  scale_shape_manual(values = 1:length(all_models)) +
  theme_minimal(base_family = "Inter", base_size = 24) +
  theme(
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  ) 

```


## Execution scalability of all forecasting methods

```{r}
#| label: fig-portability
#| echo: false
#| cache: true
#| fig-width: 14
#| fig-height: 8
#| fig-cap: "Model portability metrics for all candidate forecasting methods, relative to the Mean method. Relative MASE and QL(0.9) are reported separately for malaria and vaccine products; values below 1 indicate improvement over the Mean method."


fc_rel <- read_rds("data/results/fc_rel.rds") |>
  select(-failures) |>
  pivot_longer(
    cols      = c(rel_mase, rel_quantile_loss_90),
    names_to  = "measure",
    values_to = "value"
  ) |>
  mutate(
    measure = recode(
      measure,
      rel_mase            = "Rel. MASE",
      rel_quantile_loss_90 = "Rel. QL(0.9)"
    ),
    measure = factor(measure, levels = c("Rel. MASE", "Rel. QL(0.9)"))
  ) |> 
  mutate(failure = if_else(model %in% c('ARIMA Climate', 'ARIMA Madagaskar'), 'Model Faliure', 'None'))

fc_rel |>
  mutate(model = factor(model)) |>
  ggplot(aes(
    x      = rel_running_time,
    y      = value,
    colour = failure,
    shape  = model
  )) +
  geom_point(
    # position = position_jitter(width = 0.03, height = 0.03),
    size     = 3,
    stroke   = 1
  ) +
  facet_grid(cols = vars(case), rows = vars(measure), scales = "free", switch = "y") +
  scale_colour_manual(
  values = c(
    "Model Faliure" = "#D55E00",  # red (failure)
    "None"          = "#009E73"   # green (no failure)
  )) +
  scale_shape_manual(values = 0:14) +
  labs(
    x = "Relative runtime (seconds per series and forecast origin)",
    y = NULL,
    colour = "Failure status",
    shape  = "Model"
  ) +
  theme_minimal(base_family = "Inter", base_size = 32) +
  theme(
    strip.placement      = "outside",
    strip.background.y   = element_blank(),
    strip.text.y.left    = element_text(
      face   = "bold",
      colour = "#1a2b48",
      size   = 28
    ),
    panel.border       = element_rect(colour = "#6d8196", fill = NA, size = 0.4),
    panel.grid.major   = element_line(colour = "grey92", size = 0.35),
    panel.grid.minor   = element_blank(),
    axis.title         = element_text(face = "bold", colour = "#1a2b48"),
    axis.text          = element_text(colour = "#1a2b48"),
    legend.position    = "right",
    legend.title       = element_text(face = "bold", colour = "#1a2b48"),
    legend.text        = element_text(colour = "#1a2b48")
  ) 


```

# {.title-slide background-color="#212B49"}

<div class="title-slide">
  <h1>WHAT NEXT</h1>
</div>

## Proposed end-to-end forecasting-to-inventory architecture 

![](images/functional_diagram.png){style="width:75%; height:auto; "}
<br>

::: aside
Solid arrows represent data flow, and dashed arrows represent information feedback for learning.
:::

## {}

:::: {.columns}

::: {.column width="38%"}
![](images/wp2.png){.absolute top="-10%" left="-10%" height="120%" style="max-height: unset;"}
:::

::: {.column width="2.5%"}

:::

::: {.column width="59.5%"}

[Way forward]{.highlight-title}

<br>

::: {.fragment fragment-index=1}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Build a harmonised data foundation for supply chain forecasting.

:::

<br>

::: {.fragment fragment-index=2}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Conduct a controlled pilot using Auto ARIMA / Auto ETS.

:::

<br>

::: {.fragment fragment-index=3}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Implement quantile-based, uncertainty-driven inventory policies.

:::

<br>

::: {.fragment fragment-index=4}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Evaluate the pilot instance against real operational outcomes.

:::

<br>

::: {.fragment fragment-index=5}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Introduce preference learning and automated model selection.

:::

<br>

::: {.fragment fragment-index=6}

<i class="fa-solid fa-check-circle" style="color:#156082; font-size:36px;"></i> Automate contextual knowledge capture in the logistics stream.

:::

:::

::::


## Any questions or thoughts? üí¨ 

![](images/follow_us.png){fig-align="center"}




